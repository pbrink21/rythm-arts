<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>Board</title>
        <link rel="stylesheet" href="style.css">

    </head>
    <body>
        <div id = "title">
            <div id = "titleimg" class="titleimg">

            </div>
        </div>

        <div id = "game">
          <a class = "difButton" onclick="diff(1)" id = "0">Easy</a>
          <a class = "difButton" onclick="diff(2)" id = "1">Medium</a>
          <a class = "difButton" onclick="diff(3)" id = "2">Hard</a>
          <canvas id = "gameCanvas" width = "750" height = "750" style="border:1px solid #000000; position: absolute; top: 10%; right: 37.5%;"/>

          <script language="JavaScript">      
            var elem = document.getElementById('gameCanvas'),
            context = elem.getContext('2d'),
            started = false,
            paused = false,
            theme = "Dawn Winery",
            diff = 0;
            points = 0;
            elements = [];

            const colors = {
              "Dawn Winery":{
                numColors: 4,
                success: "#B0F54D",
                background: "#FFFFFF",
                0: "#603060",
                1: "#a8b2ba",
                2: "#ffe0c0",
                3: "#338dd8"
              },
            };

            const DIFFICULTY = {
            //size of circles changed and accel of hard 10 -> 7
              0: {size: 50, acceleration: 1, points: 1, interval: 10},
              1: {size: 40, acceleration: 5, points: 2, interval: 7},
              2: {size: 30, acceleration: 7, points: 3, interval: 5},
            };

            const DIRECTION = {
              0: {x: 0, y: -1, key: 'w', keyCode: 87, winX: elem.width/2, winY: 0}, //up
              1: {x: -1, y: 0, key: 'a', keyCode: 65, winX: 0, winY: elem.height/2}, //left
              2: {x: 0, y: 1, key: 's', keyCode: 83, winX: elem.width/2, winY: elem.height}, //down
              3: {x: 1, y: 0, key: 'd', keyCode: 68, winX: elem.width, winY: elem.height/2}, //right
              4: {x: 0, y: 0, key: 'q', keyCode: 81, winX: 0, winY: 0} //stopped
            };

            function diff(num){
                diff = num;
                getElementById(0).remove();
                getElementById(1).remove();
                getElementById(2).remove();
			}

            function intersect(point, circle){
              return Math.sqrt((point.x-circle.x) ** 2 + (point.y-circle.y) ** 2) < circle.radius;
            }

            function generate(){
              elements.push({
                color: colors[theme][Math.floor(Math.random() * colors[theme].numColors)],
                radius: DIFFICULTY[diff].size,
                x: elem.width/2,
                y: elem.height/2,
                speed: DIFFICULTY[diff].acceleration,
                ready: false,
                clicked: false,
                direction: DIRECTION[Math.floor(Math.random() * 4)],
                previous: {
                  x: elem.width/2,
                  y: elem.height/2,
                  radius: DIFFICULTY[diff].acceleration + 5,
                  dir: this.direction,
                }
              });
            }

            function start(){
              started = true;
              generate();
              context.fillStyle = colors[theme].background;
              context.rect(0, 0, elem.width, elem.height);
              context.fill();
              elements.forEach(function(element){
                draw(element.x, element.y, element.radius, element.color);
              });
              var numCircles = 10;
              var sn = setInterval(function(){
                iterate();
                if(elements.length == 0){
                  generate();
                  numCircles--;
                }
                if(numCircles <= 0){
                  clearInterval(sn);
                  alert("you have gotten " + points + " points");
                }
              }, DIFFICULTY[diff].interval);
            }

            function pause(){
              elements.forEach(function(element){
                element.previous.dir = element.direction;
                element.direction = DIRECTION[4];
              })
            }

            function resume(){
              elements.forEach(function(element){
                element.direction = element.previous.dir;
              })
            }

            function iterate(){
              elements.forEach(function(element){
                var pos = {
                  x: element.direction.winX,
                  y: element.direction.winY
                };
                //changes color, if neccesary
                if(intersect(pos, element)){
                  element.ready = true;
                  element.color = colors[theme].success;
                }
                //stores data for previous circle
                element.previous.x = element.x;
                element.previous.y = element.y;
                element.previous.radius = element.radius + 5;
                //moves circle forward
                element.x = element.x + (element.direction.x * element.speed);
                element.y = element.y + (element.direction.y * element.speed);
                //erases old Circles
                draw(element.previous.x, element.previous.y, element.previous.radius, colors[theme].background);
                //prints new Circles
                draw(element.x, element.y, element.radius, element.color);

                if((!intersect(pos, element) && element.ready) || element.clicked){
                  //erases
                  /*
                  *see line 167*
                  if(!element.clicked){
                    points -= DIFFICULTY[diff].points;
                  }
                  */
                  draw(element.x, element.y, element.radius, colors[theme].background);
                  elements.splice(elements.indexOf(element));
                }
              });
            }

            function draw(x, y, r, c){
              context.fillStyle = c;
              context.beginPath();
              context.arc(x, y, r, 0, 2 * Math.PI);
              context.fill();
            }

            function handleClick(clicked){
              var goodClick = false;
              elements.forEach(function(element){
                if((element.direction.keyCode == clicked && element.ready && !element.clicked)){
                  goodClick = true;
                  element.clicked = true;
                  points += DIFFICULTY[diff].points;
                }
              });
              //Dont think we should subtract for points but only give points to successful scores?
              /*
              if(!goodClick){
                points -= DIFFICULTY[diff].points;
              }
              */
            }

            context.font = "30px Arial";
            context.fillText("Press space to start", 10, 50);

            document.addEventListener('keydown', function(event) {
              if(event.keyCode == 32){
                if(started){
                  if(paused){
                    resume();
                    paused = false;
                  }else{
                    pause();
                    paused = true;
                  }
                }else{
                  start();
                }
              }else{
                handleClick(event.keyCode);
              }
            }, false);

          </script>
        </div>
    </body>
</html>
